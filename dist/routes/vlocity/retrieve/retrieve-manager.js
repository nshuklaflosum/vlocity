const a42_0x3797fd=a42_0xed6d;(function(_0xe47433,_0x4ebbd8){const _0x264406=a42_0xed6d,_0x7cee73=_0xe47433();while(!![]){try{const _0x31eab6=-parseInt(_0x264406(0x17f))/0x1+-parseInt(_0x264406(0x14c))/0x2*(parseInt(_0x264406(0x1a1))/0x3)+parseInt(_0x264406(0x16d))/0x4*(parseInt(_0x264406(0x16a))/0x5)+parseInt(_0x264406(0x18f))/0x6+-parseInt(_0x264406(0x150))/0x7+-parseInt(_0x264406(0x174))/0x8*(parseInt(_0x264406(0x1a7))/0x9)+parseInt(_0x264406(0x198))/0xa*(parseInt(_0x264406(0x154))/0xb);if(_0x31eab6===_0x4ebbd8)break;else _0x7cee73['push'](_0x7cee73['shift']());}catch(_0x50d178){_0x7cee73['push'](_0x7cee73['shift']());}}}(a42_0x57cc,0x829f6));function a42_0x57cc(){const _0x454854=['access','snapshotId','Error\x20create\x20snapshot\x20','toLowerCase','Records\x20to\x20export\x20not\x20a\x20found','Create\x20project\x20directory','callUpdateLog','adm-zip','994682StmOTB','updateAttachmentLog','then','fs/promises','errors','../../../constants','replaceAll','../../../config/dotenv','mkdir','has','sendLogs','-Export.yaml','readErrors','jsForceService','isSMV','F_OK','1384788DUEjmx','records','Prepare\x20manifests','flosumAuth','\x0a\x20-\x20','selective','load','vlocityAuth','namespace','270vWtIcz','stringify','addLocalFolder','path','Is_Completed__c','attachmentId','addLogsToAttachment','constants','./retriever','9DFVGhe','appendFile','Start\x20Update\x20Snapshot','Vlocity\x20Temp','map','readdir','3529755kRAzlN','includes','../../../services/cli-commands/available-to-export.command','some','base64','projectPath','createProjectDirectory','createAttachment','End\x20Send\x20Vlocity\x20Temp','execute','toString','../../../services/http','toBuffer','Start\x20prepare\x20to\x20retrieve','join','\x0amanifest:\x0a\x20-\x20','readFile','exports','147206XTuKXV','isSupportAccessToken','End\x20retrieve\x20chunk\x20','length','5337997hYslyi','componentNames','\x5c\x27\x27','projectPath:\x20./','1055021kBgOII','End\x20Update\x20Snapshot','getComponentKeysByTypes','../../../services/js-force','getJobLogFilePath','updateLog','application/zip','Is_Error__c','updateSnapshot','prepareManifests','snapshotChunk','manifests','catch','sendVlocityTemp','yamlContent','push','logId','log','logs','Errors','FlosumErrors:\x20','types','212230uFCiTe','Start\x20send\x20retrieved\x20data\x20','yaml','8nCXdhG','componentTypes','clearData','componentKeys','utf8','maxDepth','logger','8PrEnmn','retrieveType','End\x20send\x20retrieved\x20data\x20'];a42_0x57cc=function(){return _0x454854;};return a42_0x57cc();}const fs=require(a42_0x3797fd(0x182)),path=require(a42_0x3797fd(0x19b)),AdmZip=require(a42_0x3797fd(0x17e)),yaml=require('js-yaml'),{VLOCITY_TEMP_CATALOG,UNZIP_CATALOG_NAME}=require(a42_0x3797fd(0x184)),{splitOnChunks}=require('../../../services/utils'),{AvailableToExportCommand}=require(a42_0x3797fd(0x1a9)),{Logger}=require('../../../services/logger'),{Retriever}=require(a42_0x3797fd(0x1a0)),{SnapshotComponentSender}=require('./snapshot-component-sender'),{JsForceHelper}=require(a42_0x3797fd(0x157)),http=require(a42_0x3797fd(0x145)),{configureObject}=require(a42_0x3797fd(0x186)),jobOptions={'projectPath':'','yamlContent':'','namespace':'','snapshotId':'','logId':'','attachmentId':'','retrieveType':a42_0x3797fd(0x194)||a42_0x3797fd(0x169),'componentKeys':[''],'componentTypes':[''],'componentNames':[''],'flosumAuth':{'instanceUrl':'','accessToken':''},'vlocityAuth':{'instanceUrl':'','accessToken':''},'maxDepth':0x0,'isRetry':![],'isSMV':![],'isSCPV':![],'logger':new Logger()};class RetrieveManager{constructor({projectPath:_0x182504,yamlContent:_0xff2e03,namespace:_0x11cdcf,snapshotId:_0x3b635a,logId:_0x837a40,attachmentId:_0x56b473,flosumAuth:_0x2a349c,vlocityAuth:_0x3ccd2b,maxDepth:_0x169bda,isRetry:_0x3f22fa,isSMV:_0x492352,isSCPV:_0x4e819b,retrieveType:_0x2ba7e1,componentKeys:_0x3ecbc9,componentNames:_0x2f3873,componentTypes:_0x15d580,retrieveOptions:_0x276d5b,logger:_0x2eb76d}=jobOptions){const _0x5b3c17=a42_0x3797fd;this[_0x5b3c17(0x13f)]=_0x182504,this['yamlContent']=_0xff2e03,this[_0x5b3c17(0x197)]=_0x11cdcf,this[_0x5b3c17(0x178)]=_0x3b635a,this[_0x5b3c17(0x164)]=_0x837a40,this[_0x5b3c17(0x19d)]=_0x56b473,this['flosumAuth']=_0x2a349c,this['vlocityAuth']=_0x3ccd2b,this['maxDepth']=_0x169bda,this['isRetry']=_0x3f22fa,this[_0x5b3c17(0x18d)]=_0x492352,this['isSCPV']=_0x4e819b,this[_0x5b3c17(0x175)]=_0x2ba7e1,this[_0x5b3c17(0x170)]=_0x3ecbc9,this[_0x5b3c17(0x151)]=_0x2f3873,this[_0x5b3c17(0x16e)]=_0x15d580,this[_0x5b3c17(0x173)]=_0x2eb76d,this['manifests']=[],this[_0x5b3c17(0x183)]=[],this['isSupportAccessToken']=!![],this[_0x5b3c17(0x18c)]=new JsForceHelper(this[_0x5b3c17(0x192)],this[_0x5b3c17(0x173)]);}async[a42_0x3797fd(0x140)](){const _0x26abee=a42_0x3797fd;this[_0x26abee(0x173)][_0x26abee(0x165)](_0x26abee(0x17c)),await fs[_0x26abee(0x187)](this[_0x26abee(0x13f)],{'recursive':!![]});}async[a42_0x3797fd(0x156)](){const _0xdfcc80=a42_0x3797fd,_0x2b9a85=await new AvailableToExportCommand({'vlocityAuth':this[_0xdfcc80(0x196)],'logger':this[_0xdfcc80(0x173)]})[_0xdfcc80(0x143)]();if(!_0x2b9a85?.['records']?.[_0xdfcc80(0x14f)])throw new Error(_0xdfcc80(0x17b));const _0x1cc381=new Set(this[_0xdfcc80(0x16e)]);return _0x2b9a85[_0xdfcc80(0x190)]['filter'](({VlocityDataPackType:_0x58458a,Name:_0x3de3b0,VlocityDataPackDisplayLabel:_0x26eac2,VlocityDataPackKey:_0x31dc32})=>{const _0x54a64a=_0xdfcc80;if(!_0x1cc381[_0x54a64a(0x188)](_0x58458a))return![];const _0x1002a8=_0x3de3b0?.['toLowerCase']()||'',_0x2c5c0a=_0x26eac2?.[_0x54a64a(0x17a)]()||'',_0x35ceb8=_0x31dc32?.[_0x54a64a(0x17a)]()||'';return this[_0x54a64a(0x151)][_0x54a64a(0x13d)](_0x440eb6=>_0x1002a8[_0x54a64a(0x1a8)](_0x440eb6[_0x54a64a(0x17a)]()))||this[_0x54a64a(0x151)]['some'](_0xaad9c9=>_0x2c5c0a[_0x54a64a(0x1a8)](_0xaad9c9['toLowerCase']()))||this['componentNames'][_0x54a64a(0x13d)](_0x59c44e=>_0x35ceb8['includes'](_0x59c44e[_0x54a64a(0x17a)]()));})['map'](({VlocityDataPackKey:_0x273393})=>'\x27'+_0x273393[_0xdfcc80(0x185)]('\x27',_0xdfcc80(0x152))+'\x27');}async[a42_0x3797fd(0x15d)](){const _0x254949=a42_0x3797fd;this['logger']['log'](_0x254949(0x191));if(this[_0x254949(0x175)]==='selective'&&this[_0x254949(0x170)]?.[_0x254949(0x14f)]){const _0x2041ed=this[_0x254949(0x170)][_0x254949(0x1a5)](_0x360bec=>'\x27'+_0x360bec['replaceAll']('\x27','\x5c\x27\x27')+'\x27'),_0x265b0d=_0x254949(0x153)+UNZIP_CATALOG_NAME+_0x254949(0x149);this[_0x254949(0x15f)]=splitOnChunks(_0x2041ed,configureObject[_0x254949(0x15e)])[_0x254949(0x1a5)](_0x3cb409=>''+_0x265b0d+_0x3cb409[_0x254949(0x148)](_0x254949(0x193)));return;}if(this[_0x254949(0x175)]===_0x254949(0x16c)){this[_0x254949(0x15f)]=[this[_0x254949(0x162)]];return;}const _0x1e7060=await this[_0x254949(0x156)](),_0x438de8=_0x254949(0x153)+UNZIP_CATALOG_NAME+'\x0amanifest:\x0a\x20-\x20';this[_0x254949(0x15f)]=splitOnChunks(_0x1e7060,configureObject[_0x254949(0x15e)])['map'](_0x4f5cf2=>''+_0x438de8+_0x4f5cf2['join'](_0x254949(0x193)));}async[a42_0x3797fd(0x16f)](){const _0x138f6e=a42_0x3797fd,_0x3d23ef=await fs[_0x138f6e(0x1a6)](this['projectPath']);for(const _0x166cef of _0x3d23ef){if(_0x166cef['startsWith']('data'))continue;await fs['rm'](path['join'](this[_0x138f6e(0x13f)],_0x166cef),{'recursive':!![]});}}async[a42_0x3797fd(0x161)](){const _0x4a22dd=a42_0x3797fd;if(this[_0x4a22dd(0x15f)][_0x4a22dd(0x14f)]!==0x1)return;const _0x19d5f7=await this['prepareJobData']();if(!_0x19d5f7)return;this[_0x4a22dd(0x173)][_0x4a22dd(0x165)]('Start\x20Send\x20Vlocity\x20Temp');const _0x589013={'Name':_0x4a22dd(0x1a4),'ContentType':_0x4a22dd(0x15a),'Description':_0x4a22dd(0x1a4),'ParentId':this[_0x4a22dd(0x178)],'Body':_0x19d5f7};await this['jsForceService'][_0x4a22dd(0x141)](_0x589013),this['logger']['log'](_0x4a22dd(0x142));}async['getJobLogFilePath'](){const _0x1da323=a42_0x3797fd,_0x3e0191=path[_0x1da323(0x148)](this[_0x1da323(0x13f)],VLOCITY_TEMP_CATALOG),_0x199e20=await fs[_0x1da323(0x177)](_0x3e0191,fs[_0x1da323(0x19f)][_0x1da323(0x18e)])[_0x1da323(0x181)](()=>!![])['catch'](()=>![]);if(!_0x199e20)return;const _0x36da7b=path[_0x1da323(0x148)](_0x3e0191,_0x1da323(0x166)),_0x5f1f85=await fs[_0x1da323(0x177)](_0x36da7b,fs[_0x1da323(0x19f)][_0x1da323(0x18e)])[_0x1da323(0x181)](()=>!![])[_0x1da323(0x160)](()=>![]);if(!_0x5f1f85)return;const _0xe2a72b=await fs['readdir'](_0x36da7b);if(!_0xe2a72b?.[_0x1da323(0x14f)])return;for(const _0x440ed9 of _0xe2a72b){if(!_0x440ed9[_0x1da323(0x1a8)]('job-yaml-'))continue;if(!_0x440ed9[_0x1da323(0x1a8)](_0x1da323(0x18a)))continue;return path[_0x1da323(0x148)](_0x36da7b,_0x440ed9);}}async['prepareJobData'](){const _0x17d156=a42_0x3797fd,_0x5a9e89=await this['getJobLogFilePath']();if(!_0x5a9e89)return;const _0xb4812e=_0x17d156(0x168)+JSON[_0x17d156(0x199)](this[_0x17d156(0x173)]['errors']);await fs[_0x17d156(0x1a2)](_0x5a9e89,_0xb4812e);const _0x32dd56=new AdmZip();return _0x32dd56[_0x17d156(0x19a)](path[_0x17d156(0x148)](this[_0x17d156(0x13f)],VLOCITY_TEMP_CATALOG),VLOCITY_TEMP_CATALOG),_0x32dd56[_0x17d156(0x146)]()[_0x17d156(0x144)](_0x17d156(0x13e));}async[a42_0x3797fd(0x18b)](){const _0x215a12=a42_0x3797fd,_0x4fd5c5=await this[_0x215a12(0x158)]();if(!_0x4fd5c5)return;const _0x16ef22=await fs[_0x215a12(0x14a)](_0x4fd5c5,_0x215a12(0x171)),_0x36c491=yaml[_0x215a12(0x195)](_0x16ef22,{});if(!_0x36c491?.[_0x215a12(0x167)]?.[_0x215a12(0x14f)])return;for(const _0x5c0120 of _0x36c491['Errors']){this['errors'][_0x215a12(0x163)](_0x5c0120);}}async[a42_0x3797fd(0x19e)](){const _0x4d28a4=a42_0x3797fd;await http[_0x4d28a4(0x180)](this['projectPath'],this[_0x4d28a4(0x18c)],this[_0x4d28a4(0x19d)],this[_0x4d28a4(0x173)],!!this['errors'][_0x4d28a4(0x14f)],!![]);}async['updateLog'](){const _0x78ec0a=a42_0x3797fd;await http[_0x78ec0a(0x17d)](this[_0x78ec0a(0x18c)],this['logId'],this['namespace'],!![],this[_0x78ec0a(0x173)],!!this[_0x78ec0a(0x183)][_0x78ec0a(0x14f)]);}async['sendLogs'](){const _0x1b6280=a42_0x3797fd;await http[_0x1b6280(0x180)](this['projectPath'],this['jsForceService'],this['attachmentId'],this[_0x1b6280(0x173)],![]);if(!this[_0x1b6280(0x14d)])return;await new Promise(_0x31b3=>setTimeout(()=>_0x31b3(),0x2710)),await this['sendLogs']();}async[a42_0x3797fd(0x15c)](){const _0xa80eaf=a42_0x3797fd;this[_0xa80eaf(0x173)][_0xa80eaf(0x165)](_0xa80eaf(0x1a3));const _0x4e48f6={'Id':this[_0xa80eaf(0x178)],[this[_0xa80eaf(0x197)]+_0xa80eaf(0x19c)]:!![],[this[_0xa80eaf(0x197)]+_0xa80eaf(0x15b)]:!!this[_0xa80eaf(0x183)][_0xa80eaf(0x14f)]};await this[_0xa80eaf(0x18c)][_0xa80eaf(0x15c)](this[_0xa80eaf(0x197)],_0x4e48f6),this[_0xa80eaf(0x173)][_0xa80eaf(0x165)](_0xa80eaf(0x155));}async[a42_0x3797fd(0x143)](){const _0x30cb3c=a42_0x3797fd;this[_0x30cb3c(0x173)][_0x30cb3c(0x165)](_0x30cb3c(0x147));try{this[_0x30cb3c(0x189)](),await this[_0x30cb3c(0x140)](),await this[_0x30cb3c(0x15d)](),this[_0x30cb3c(0x173)]['log']('End\x20prepare\x20to\x20retrieve,\x20'+this['manifests'][_0x30cb3c(0x14f)]+'\x20chunks');const _0x51db73=new SnapshotComponentSender({'projectPath':this[_0x30cb3c(0x13f)],'namespace':this[_0x30cb3c(0x197)],'snapshotId':this[_0x30cb3c(0x178)],'flosumAuth':this[_0x30cb3c(0x192)],'logger':this[_0x30cb3c(0x173)]});let _0x2f27e5=0x1;for(const _0x26c593 of this['manifests']){this[_0x30cb3c(0x173)][_0x30cb3c(0x165)]('Start\x20retrieve\x20chunk\x20'+_0x2f27e5),await new Retriever({'projectPath':this[_0x30cb3c(0x13f)],'vlocityAuth':this[_0x30cb3c(0x196)],'maxDepth':this[_0x30cb3c(0x172)],'isRetry':this['isRetry'],'isSMV':this['isSMV'],'isSCPV':this['isSCPV'],'logger':this[_0x30cb3c(0x173)],'manifest':_0x26c593})['execute'](),this[_0x30cb3c(0x173)][_0x30cb3c(0x165)](_0x30cb3c(0x14e)+_0x2f27e5),this[_0x30cb3c(0x173)][_0x30cb3c(0x165)](_0x30cb3c(0x16b)+_0x2f27e5),await _0x51db73[_0x30cb3c(0x143)](),this[_0x30cb3c(0x173)]['log'](_0x30cb3c(0x176)+_0x2f27e5),await this[_0x30cb3c(0x18b)](),await this[_0x30cb3c(0x16f)](),_0x2f27e5++;}await fs['rm'](this[_0x30cb3c(0x13f)],{'recursive':!![]}),await this[_0x30cb3c(0x161)]();}catch(_0x35f857){this[_0x30cb3c(0x173)][_0x30cb3c(0x165)](_0x30cb3c(0x179)+_0x35f857),this['errors'][_0x30cb3c(0x163)](_0x30cb3c(0x179)+_0x35f857),await this[_0x30cb3c(0x159)]();}this[_0x30cb3c(0x14d)]=![],await this[_0x30cb3c(0x159)](),await this[_0x30cb3c(0x19e)](),await this[_0x30cb3c(0x15c)]();}}function a42_0xed6d(_0x1a5729,_0x4fa5a6){const _0x57ccd3=a42_0x57cc();return a42_0xed6d=function(_0xed6d9c,_0x41959b){_0xed6d9c=_0xed6d9c-0x13d;let _0x20bcf2=_0x57ccd3[_0xed6d9c];return _0x20bcf2;},a42_0xed6d(_0x1a5729,_0x4fa5a6);}module[a42_0x3797fd(0x14b)]={'RetrieveManager':RetrieveManager};